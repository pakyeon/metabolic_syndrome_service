# 노트

# 대사증후군 상담사 어시스턴트 - 구현 전략

## 시스템 아키텍처 개요

### 전체 구조

프론트엔드는 CopilotKit과 AG-UI 프로토콜을 사용하여 상담사에게 직관적인 인터페이스를 제공합니다. 백엔드는 LangGraph로 복잡한 RAG 파이프라인을 오케스트레이션하며, 상황에 따라 적응적으로 검색 전략을 변경합니다. 데이터 레이어는 Vector DB(**Chroma**), Graph DB(**Graphiti_core**, **Neo4j**), 캐시레이어로 구성되어 각각의 강점을 활용합니다.

### 핵심 철학: Adaptive RAG

시스템의 가장 중요한 특징은 "질문을 먼저 이해하고, 상황에 맞는 최적의 전략을 동적으로 선택한다"는 점입니다. 모든 질문에 동일한 파이프라인을 적용하는 대신, 질문의 복잡도와 상담 상황을 분석하여 가장 효율적인 방법을 선택합니다.

### 시스템의 역할과 한계

**명확한 역할 정의**
이 시스템은 상담사를 보조하는 정보 제공 도구입니다. 운동과 식단에 대한 제안과 권장사항을 전달하며, 환자의 상태에 대한 정보를 제공합니다. 절대로 치료 판단, 약물 처방, 의학적 진단을 수행하지 않습니다.

**안전장치**
시스템은 다음과 같은 질문이나 요청에 대해 명확히 거부합니다:

- 약물 복용량 변경 제안
- 특정 약물 추천 또는 중단 권고
- 질병 진단 또는 예후 판단
- 의학적 처치 결정

대신 "이 부분은 담당 의사와 상담이 필요합니다"라고 안내하며, 상담사에게 전문의 에스컬레이션을 권장합니다.

---

## 통합 사용자 여정: 상담 준비에서 실시간 상담까지

### 전체 플로우

상담사는 하나의 연속된 경험 안에서 상담 준비와 실시간 상담을 진행합니다. 시스템은 상담사의 행동을 관찰하여 자동으로 모드를 전환하고, 각 상황에 최적화된 응답을 제공합니다.

**여정의 시작**: 상담사가 로그인하여 대사증후군 검진을 받은 환자들이 나열된 리스트에서 특정 환자를 선택하면 시스템은 자동으로 상담 준비 모드로 진입합니다.

**상담 준비 단계**: 환자 차트를 불러오고, 상담사가 "상담 준비" 버튼을 클릭하면 시스템은 환자의 기록을 분석하기 시작합니다. 이 단계에서는 시간이 다소 걸리더라도 필요한 정보를 충분히 제공하는 것이 목표입니다.

**상담 시작 전환**: 상담사가 "상담 시작" 버튼을 누르면 시스템은 즉시 실시간 모드로 전환됩니다. 이제부터는 모든 응답이 5~10초 이내에 제공되어야 합니다.(질문 입력부터 답변 스트리밍 시작까지의 지연 시간이 기준)

**상담 진행 중**: 환자가 질문을 할 때마다 상담사는 챗봇에 질문을 입력하고, 거의 실시간에 가까운 답변을 받아 환자에게 즉시 전달할 수 있습니다.

**상담 종료**: 상담이 끝나면 시스템은 세션을 저장하고, 오늘 다룬 주제들을 요약하여 다음 상담 준비에 활용할 수 있도록 합니다.

---

## 상담 준비 상황 - 상세 구현 전략

### 사용 시점 및 상황

상담사는 다음 환자와 만나기 전 5-10분 정도의 준비 시간을 가집니다. 이 시간에 환자의 이전 기록을 훑어보고, 주요 이슈를 파악하며, 예상되는 질문에 대한 답변을 미리 준비합니다. 특히 신입 상담사에게는 이 준비 시간이 매우 중요합니다.

### 프론트엔드 UI/UX 전략

**화면 구성의 철학**
화면은 세 개의 주요 영역으로 나뉩니다. 좌측에는 환자의 대사증후군 검진 정보가 항상 표시됩니다. 약물 정보는 참고용으로만 표시하며(없을 수 있음), 시스템이 이에 대한 판단은 하지 않습니다. 중앙에는 AI 어시스턴트와의 대화 공간이 있으며, 우측에는 시스템이 생성한 상담 준비 자료가 실시간으로 쌓입니다.

**CopilotKit의 역할**
CopilotKit은 단순한 채팅 인터페이스를 넘어서, 상담사의 의도를 이해하고 적절한 정보를 제공하는 역할을 합니다. 예를 들어 상담사가 "환자의 운동 능력은 어느 정도인가요?"라고 입력하면, 시스템은 자동으로 환자의 현재 활동 수준과 권장 운동 강도를 분석합니다.(기초설문지의 내용을 참조)

**빠른 액션 버튼**
상담사가 매번 자연어로 요청하는 것은 번거로울 수 있으므로, 자주 사용하는 작업을 버튼으로 제공합니다: "상담 준비 시작", "운동 계획 권장사항", "식단 권장사항", "생활습관 개선 포인트" 등. 이 버튼들은 미리 정의된 프롬프트를 백엔드로 전송합니다.

**상담 준비 사이드바의 구성**
우측 사이드바는 AI가 생성한 준비 자료를 구조화하여 보여줍니다:

- **환자 기초설문지 내용:** 기초설문지 내용을 기반으로 ****환자 스스로 판단한 현재 환자의 주관적 정보
- **환자 상태**: 대사증후군 검사를 통해 도출된 현재 몸 상태에 대한 객관적 정보
- **핵심 포인트**: 오늘 상담에서 다뤄야 할 3-5가지 핵심사항 (운동, 식단 관련)
- **예상 질문 & 권장 답변**: 환자가 물어볼 가능성이 높은 질문들과 그에 대한 추천 답변
- **전달 방식 예시**: 환자의 이해 수준에 맞춰 어떻게 설명할지에 대한 구체적 예시
- **주의사항**: 특별히 조심스럽게 다뤄야 할 주제 (단, 의학적 판단은 제외)

**로딩 상태의 세심한 처리**
상담 준비 분석은 20-30초 정도 걸릴 수 있습니다. 이 시간 동안 상담사가 무작정 기다리는 것이 아니라, 시스템이 "지금 무엇을 하고 있는지"를 명확히 보여줍니다. "환자 기록 검색 중...", "관련 운동 가이드라인 찾는 중...", "식단 권장사항 분석 중..." 같은 메시지를 순차적으로 표시하여 진행 상황을 투명하게 공유합니다.

### 백엔드 처리 전략

**환자 데이터의 사전 로딩**
상담사가 환자를 선택하는 순간, 시스템은 백그라운드에서 해당 환자의 모든 관련 정보를 미리 불러옵니다. 기초설문지 작성 내용, 대사증후군 검사 기록, 이전 상담 기록 등을 한 번에 로드하여 이후 분석에서 반복적인 DB 조회를 피합니다.

**구조화된 상담 준비 분석**
상담 준비 상황에서 시스템은 명확한 단계를 거쳐 정보를 생성합니다:

1. **환자 상태 분석**: 제공된 검사 수치와 기록을 바탕으로 현재 상태를 요약합니다. "55세 남성, BMI 28.5(과체중), 혈압 140/90(경계), 혈당 180(관리 필요)"와 같은 객관적 사실만 전달합니다.
2. **이전 상담 패턴 파악**: 지난 상담에서 다뤘던 주제, 환자의 실천 여부, 어려워했던 부분 등을 정리합니다.(없을 수 있음)
3. **예상 질문 생성**: 환자의 패턴과 현재 상태를 고려하여 "이번 상담에서 나올 법한 질문"을 예측합니다. 예를 들어:
    - "지난번에 걷기 운동을 시작하기로 했는데, 실천 여부 확인"
    - "혈당이 높은 상태인데, 운동 강도 조절 관련 질문 가능"
    - "식단 조절이 어렵다고 했으니, 실천 가능한 구체적 방법 문의 예상"
4. **권장 답변 준비**: 각 예상 질문에 대해 내부 가이드라인 기반의 답변을 미리 작성합니다. 이 답변은 항상 "제안"과 "권장"의 형태이며, 강제나 처방의 뉘앙스는 피합니다.
5. **전달 방식 예시 생성**: 같은 정보라도 환자의 이해 수준, 나이, 이전 반응을 고려하여 어떻게 전달하면 좋을지 구체적 예시를 제공합니다.
    - "BMI가 높다"라고 직접 말하기보다 "현재 체중이 건강 범위보다 조금 높은 편이에요"
    - 전문 용어 대신 쉬운 표현 사용 권장
    - 긍정적 프레이밍 제안: "이만큼 개선되었어요" 강조

**정보의 출처 명시**
시스템이 제공하는 모든 권장사항은 반드시 근거를 명시합니다. "대한비만학회 가이드라인 2024", "대사증후군 관리 지침" 등의 출처를 함께 표시하여, 상담사가 신뢰할 수 있고 필요 시 확인할 수 있게 합니다.

**의학적 판단 회피**
시스템이 절대 하지 않는 것들:

- "이 약을 복용해야 합니다" (X)
- "운동을 하면 안 됩니다" (X) - 대신 "의사 확인 필요" (O)
- "당뇨 진단입니다" (X)
- "약을 바꾸세요" (X)

시스템이 하는 것들:

- "일반적으로 권장되는 운동은..." (O)
- "이런 식단 패턴이 도움이 될 수 있습니다" (O)
- "이 부분은 담당 의사와 상담이 필요합니다" (O)
- "비슷한 상황의 다른 분들은 이렇게 했습니다" (O)

---

## 실시간 상담 상황 - 상세 구현 전략

### 사용 시점 및 상황

환자가 상담사 앞에 앉아 있고, 대화가 진행되는 중입니다. 환자가 질문을 하면 상담사는 즉시 답변해야 하는 압박감을 느낍니다. 만약 정확히 모르는 내용이라면, 환자에게 "잠시만요, 확인해볼게요"라고 말하고 챗봇에 질문을 입력합니다. 이때 시스템은 10초 이내에 답변을 제공해야 합니다. 더 오래 걸리면 어색한 침묵이 생기고 환자는 불안해합니다.

### 프론트엔드 UI/UX 전략

**화면 레이아웃의 변화**
실시간 상담 모드로 전환되면, 좌측의 준비 자료는 접어서 최소화하고, 중앙의 채팅 영역을 최대한 넓게 확보합니다. 상담사의 주의는 환자에게 있어야 하므로, 화면은 가능한 한 단순하게 유지합니다.

**준비된 자료의 역할 전환**
상담 준비에서 생성된 자료는 접어두지만 완전히 사라지지는 않습니다. 작은 아이콘 형태로 남아있어, 필요할 때 클릭하여 빠르게 참조할 수 있습니다.

**실시간 입력의 최적화**
상담사는 환자와 눈을 맞추면서 동시에 챗봇에 질문을 입력해야 합니다. 이를 위해 입력창은 항상 화면 하단에 고정되며, Enter 키를 누르면 즉시 질문이 전송되고, 상담사는 다시 환자에게 시선을 돌릴 수 있습니다.

**AG-UI 프로토콜로 진행 상황 표시**
답변을 기다리는 동안, 시스템이 "무엇을 하고 있는지"를 실시간으로 보여줍니다:

이 프로세스를 보여줌으로써 상담사는 시스템이 단순히 멈춘 것이 아니라 열심히 일하고 있다는 것을 알 수 있고, 환자에게도 "지금 정확한 정보를 확인하고 있습니다"라고 자연스럽게 설명할 수 있습니다.

**답변 카드의 디자인**
답변은 크고 명확한 카드 형태로 표시됩니다. 핵심 권장사항은 굵은 글씨로 상단에, 근거나 참고사항은 작은 글씨로 하단에 배치합니다. 상담사가 한 눈에 핵심만 빠르게 파악하고, 환자에게 전달할 수 있도록 합니다.

**안전 경고의 명확한 표시**
만약 질문이 의학적 판단 영역에 해당한다면, 답변 카드 상단에 노란색 경고 배너가 표시됩니다: "⚠️ 이 질문은 담당 의사와의 상담이 필요합니다." 시스템은 일반적인 정보만 제공하고, 상담사에게 에스컬레이션을 권장합니다.

**참고 자료 패널의 활용**
우측에는 방금 제공된 답변의 근거가 되는 문서 출처가 표시됩니다. 상담사가 클릭하여 원문을 볼 수 있습니다.

### 백엔드 처리 전략

**질문 분석의 초고속 판단**
환자가 기다리고 있으므로 모든 과정이 빨라야 합니다. 첫 단계인 질문 분석은 1~3초 이내에 완료되어야 합니다. 시스템은 즉시 다음을 판단합니다:

- 이 질문이 운동/식단 영역인가?
- 의학적 판단이 필요한 영역인가?
- 질문의 복잡도는 어느 정도인가?

**의료 판단 영역 자동 감지**
시스템은 다음과 같은 키워드나 패턴이 포함된 질문을 자동으로 감지합니다:

- 약물 관련: "약", "처방", "복용량", "부작용"
- 진단 관련: "병", "진단", "~인가요?"
- 치료 결정: "해도 되나요?" (의학적 허가가 필요한 맥락)
- 증상 판단: "이상한가요?", "위험한가요?"

이런 질문에 대해서는 일반 정보만 제공하고, 반드시 "담당 의사와 상담 필요"라는 안내를 포함합니다.

**검색 전략의 동적 선택**
질문 분석 결과에 따라 시스템은 즉시 전략을 결정합니다:

- **단순 질문**: Vector Search만 사용, Top 3개 문서 검색 (가장 빠름, ~5초)
- **중간 질문**: 질문 재작성 후 Vector Search로 Top 5개 문서 검색 또는 두 개 이상의 요소의 관계에 대한 질문일 경우 Graph Search 로 Top 5개 문서 검색(~7초)
- **복잡한 질문**: 질문 세분화 후 각 세분화된 질문에 맞게 Vector, Graph Search 병렬로 실행, 세분화된 질문별로 각 Top 5개 문서 검색 (~10초)

**병렬 처리의 극대화**
여러 작업을 동시에 진행하여 시간을 절약합니다. 환자 정보 조회, Vector 검색, Graph 검색을 동시에 시작하고, 가장 먼저 도착한 결과부터 활용하기 시작합니다. 모든 결과를 기다리는 것이 아니라, 충분한 정보가 모이는 순간 답변 생성을 시작합니다.

**질문 재작성**

모호하거나 복잡한 질문의 맥락을 보완하거나 명확히 하여 검색 정확도를 높입니다.

**질문 세분화의 전략적 활용**
복잡한 질문(예: "혈당이 높은데 조깅을 해도 되나요?")은 여러 하위 질문으로 분해합니다:

1. "혈당이 높은 상태에서 운동 시 일반적 권장사항"
2. "조깅의 혈당 관리 효과"
3. "운동 시 주의사항 (저혈당 예방 등)"

이 세 질문을 병렬로 처리한 후 답변을 통합합니다. 순차 처리보다 2-3배 빠릅니다.

**캐싱의 공격적 활용**
자주 묻는 질문(FAQ)에 대해서는 미리 답변을 준비해둡니다. "운동은 얼마나 해야 하나요?", "혈당 목표치는 얼마인가요?" 같은 질문은 매번 RAG를 실행할 필요가 없습니다. 환자별로 맞춤화가 필요 없는 일반 지식은 캐시에서 즉시 가져옵니다 (~0.1초).

**답변 생성의 원칙**
실시간 모드의 답변 생성은 다음 원칙을 따릅니다:

1. **간결성**: 2-3문장으로 핵심만 전달
2. **제안의 톤**: "~하시면 좋습니다", "~를 권장드립니다" (강제 아님)
3. **구체성**: "적당히" 대신 "하루 30분, 주 5회"처럼 명확하게
4. **긍정 프레이밍**: "하지 마세요" 대신 "이렇게 하시면 더 좋습니다"
5. **근거 제시**: 간단히라도 "가이드라인에 따르면..." 언급
6. **한계 인정**: 확신이 없으면 "일반적으로는..." + "개인 상황은 의사와 상담"

**안전 우선 응답**
불확실하거나 위험 가능성이 있는 질문에는:

- 일반적인 정보만 제공
- "귀하의 구체적 상황에 맞는 조언은 담당 의사와 상담이 필요합니다" 명시
- 절대 추측이나 개인화된 의학적 조언 제공 금지

---

## 시스템의 윤리적 가드레일

### 절대 하지 않는 것

1. **의학적 진단**: “환자는 ~병입니다"
2. **약물 관련 조언**: 복용, 중단, 변경, 용량 조절
3. **치료 결정**: "수술이 필요합니다", "치료를 받으세요"
4. **위험 판단**: "괜찮습니다", "위험합니다" (의학적 맥락)
5. **증상 해석**: "이건 ~의 증상입니다"

### 항상 하는 것

1. **정보 제공**: 일반적인 운동/식단 가이드라인 공유
2. **제안과 권장**: "~해보시는 건 어떨까요?", "~를 권장드립니다"
3. **근거 명시**: 모든 권장사항의 출처 제공
4. **한계 인정**: "저는 의학적 판단을 할 수 없습니다"
5. **에스컬레이션**: 필요 시 전문가 상담 권유

### 경계선 케이스 처리

**예시: "환자가 운동 중 가슴이 아프다고 하는데 괜찮은건가?"**

나쁜 응답 (X):

- "괜찮습니다, 계속하세요"
- "심장병일 수 있습니다"
- "응급실 가세요"

좋은 응답 (O):

- "운동 중 가슴 통증은 여러 원인이 있을 수 있으며, 반드시 담당 의사와 상담이 필요합니다. 
일단 운동을 중단하시고, 증상이 지속되거나 심해지면 즉시 의료진의 도움을 받도록 유도합니다. 
제가 제공할 수 있는 것은 일반적인 운동 정보뿐이며, 귀하의 증상에 대한 판단은 의료 전문가의 영역입니다.”
